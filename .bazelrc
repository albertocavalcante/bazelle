# Bazelle - Gazelle Language Extensions
# Bazel Configuration

# ==============================================================================
# Stamping Configuration
# ==============================================================================
# Workspace status command provides git version/commit for stamped builds
build --workspace_status_command=tools/scripts/workspace_status.sh

# By default, don't stamp (faster builds, better caching)
build --nostamp

# Release config: enable stamping for versioned binaries
# Usage: bazel build --config=release //:bazelle
build:release --stamp

# ==============================================================================
# Caching
# ==============================================================================
# Enable disk cache for faster rebuilds
common --disk_cache=~/.cache/bazel-disk
common --repository_cache=~/.cache/bazel-repo

# Colorize output
common --color=yes

# Show verbose failures
common --verbose_failures

# Enable isolated extension usages (required for gazelle_rust crate_universe)
common --experimental_isolated_extension_usages

# Go configuration
# CGO enabled (required for tree-sitter used by Python gazelle)
# Using host C/C++ toolchain for now (non-hermetic)
# TODO: Configure hermetic C/C++ toolchains for reproducible cross-compilation
#       See: https://github.com/aspect-build/gcc-toolchain or llvm toolchains
# build --@rules_go//go/config:pure  # DISABLED: breaks tree-sitter CGO deps

# Suppress warnings from tree-sitter generated C parsers (null chars in string literals are intentional)
build --per_file_copt=external/.*go_tree_sitter.*\.c$@-w

# Java configuration - use remote JDK for hermetic builds
build --java_runtime_version=remotejdk_21

# Protobuf configuration - use prebuilt protoc binary (avoid compiling from source)
# See: https://blog.aspect.build/bazel-9-protobuf
common --@protobuf//bazel/toolchains:prefer_prebuilt_protoc

# Note: Ensure flags for protoc were removed because grpc_java_plugin legitimately
# needs to compile against protoc_lib. The main protoc binary uses prebuilt via
# proto toolchain (see grpc-java patch in third_party/patches/)

# Test configuration
test --test_output=errors

# CI configuration
build:ci --announce_rc
build:ci --color=no
build:ci --curses=no
build:ci --show_timestamps
build:ci --keep_going

# ==============================================================================
# IDE Integration
# ==============================================================================
# For full IDE support with Bazel-managed tools:
#   1. Install direnv: https://direnv.net/
#   2. Run: bazel run //:bazel_env
#   3. Run: direnv allow
#
# This sets up GOPACKAGESDRIVER and adds tools to PATH.

# Allow user overrides
try-import %workspace%/user.bazelrc
